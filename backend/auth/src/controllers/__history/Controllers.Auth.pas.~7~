unit Controllers.Auth;

interface

procedure Registry;

implementation

uses
  System.SysUtils, System.DateUtils, System.JSON,
  Horse, JOSE.Core.JWT, JOSE.Core.Builder, Services.Auth;

function GetToken(const AIdUsuario: string; const AExpiration: TDateTime): string;
var
  LJWT: TJWT;
begin
  LJWT := TJWT.Create;
  try
    LJWT.Claims.IssuedAt := Now;
    LJWT.Claims.Expiration := AExpiration;
    LJWT.Claims.Subject := AIdUsuario;
    Result := TJOSE.SHA256CompactToken('curso-rest-horse', LJWT);
  finally
    LJWT.Free;
  end;
end;

procedure DoLogin(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  LContent,
  LToken: TJSONObject;
  LUsuario,
  LSenha: string;
  LService: TServiceAuth;
begin
  LContent := Req.Body<TJSONObject>;

  if not LContent.TryGetValue<string>('username', LUsuario) then
    raise EHorseException.Create(THTTPStatus.BadRequest, 'Usuário não informado');

  if not LContent.TryGetValue<string>('password', LSenha) then
    raise EHorseException.Create(THTTPStatus.BadRequest, 'Senha não informada');

  LService := TServiceAuth.Create(nil);
  try
    if not LService.AllowAccess(LUsuario, LSenha) then
      raise EHorseException.Create(THTTPStatus.Unauthorized, 'Usuário não autorizado');

    LToken := TJSONObject.Create;
    LToken.AddPair('access', GetToken(LService.qryLoginid.AsString, IncHour(Now)));
    LToken.AddPair('refresh', GetToken(LService.qryLoginid.AsString, IncMonth(Now)));
    Res.Send(LToken);
  finally
    LService.Free;
  end;
end;

procedure RenewToken(Req: THorseRequest; Res: THorseResponse; Next: TProc);
begin

end;

procedure Registry;
begin
  THorse.Post('/login', DoLogin);
  THorse.Get('/refresh', RenewToken);
end;

end.
